// Serene's 24/7 Timetable Notification System
// Server-side application for reliable email notifications

const cron = require('node-cron');
const { validateConfig } = require('./config/config');
const NotificationService = require('./services/notificationService');

class TimetableNotificationServer {
  constructor() {
    this.notificationService = null;
    this.jobs = [];
  }

  // Initialize the server
  async init() {
    try {
      console.log('üöÄ Starting Serene\'s Timetable Notification System...\n');
      
      // Validate configuration
      validateConfig();
      
      // Initialize notification service
      this.notificationService = new NotificationService();
      
      // Schedule jobs
      this.scheduleJobs();
      
      // Show status
      this.showStatus();
      
      console.log('\n‚úÖ Server started successfully!');
      console.log('üíú Ready to send loving notifications to Serene 24/7!\n');
      
    } catch (error) {
      console.error('‚ùå Server initialization failed:', error.message);
      process.exit(1);
    }
  }

  // Schedule cron jobs
  scheduleJobs() {
    const { config } = require('./config/config');
    
    // Daily summary at 5:00 PM Malaysia time
    const dailySummaryJob = cron.schedule(config.schedule.dailySummary, async () => {
      await this.notificationService.sendDailySummary();
    }, {
      timezone: config.schedule.timezone,
      scheduled: false
    });

    // Class reminders (check every minute)
    const reminderJob = cron.schedule(config.schedule.reminderCheck, async () => {
      await this.notificationService.sendClassReminders();
    }, {
      timezone: config.schedule.timezone,
      scheduled: false
    });

    this.jobs = [
      { name: 'Daily Summary', job: dailySummaryJob, schedule: config.schedule.dailySummary },
      { name: 'Class Reminders', job: reminderJob, schedule: config.schedule.reminderCheck }
    ];

    // Start all jobs
    this.jobs.forEach(({ name, job }) => {
      job.start();
      console.log(`‚úÖ ${name} job scheduled and started`);
    });
  }

  // Show system status
  showStatus() {
    const status = this.notificationService.getStatus();
    
    console.log('\nüìä System Status:');
    console.log('‚îÄ'.repeat(50));
    console.log(`üîê Environment: ${process.env.NODE_ENV || 'development'}`);
    console.log(`üìß Recipient: ${status.recipient.email} (${status.recipient.name})`);
    console.log(`üåç Timezone: ${status.system.timezone}`);
    console.log(`üìÖ Current Week: ${status.current.week || 'N/A'}`);
    console.log(`üìÜ Current Day: ${status.current.day}`);
    console.log(`üìö Today's Classes: ${status.current.todayClasses}`);
    console.log(`üìö Tomorrow's Classes: ${status.tomorrow.classes}`);
    console.log('‚îÄ'.repeat(50));
    
    console.log('\n‚è∞ Scheduled Jobs:');
    this.jobs.forEach(({ name, schedule }) => {
      console.log(`  ‚Ä¢ ${name}: ${schedule}`);
    });
  }

  // Send test notification
  async sendTest() {
    try {
      console.log('\nüß™ Sending test notification...');
      await this.notificationService.sendTestNotification();
    } catch (error) {
      console.error('‚ùå Test notification failed:', error.message);
    }
  }

  // Graceful shutdown
  shutdown() {
    console.log('\nüõë Shutting down server...');
    
    this.jobs.forEach(({ name, job }) => {
      job.stop();
      console.log(`‚úÖ ${name} job stopped`);
    });
    
    console.log('‚úÖ Server shutdown complete');
    process.exit(0);
  }
}

// Initialize server
const server = new TimetableNotificationServer();

// Handle process signals
process.on('SIGINT', () => server.shutdown());
process.on('SIGTERM', () => server.shutdown());

// Handle uncaught exceptions
process.on('uncaughtException', (error) => {
  console.error('‚ùå Uncaught Exception:', error.message);
  server.shutdown();
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('‚ùå Unhandled Rejection at:', promise, 'reason:', reason);
  server.shutdown();
});

// Start the server
server.init();

// Export for testing
module.exports = server;